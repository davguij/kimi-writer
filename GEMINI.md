# GEMINI.md

This document provides a comprehensive overview of the Kimi Writer project, designed to serve as a persistent context for AI-assisted development.

## Project Overview

Kimi Writer is an autonomous agent written in Python that uses the Moonshot AI `kimi-k2-thinking` model to perform creative writing tasks. The agent can create novels, books, and short story collections based on a user's prompt.

The agent operates in a loop, reasoning about the user's request, deciding which tools to use, and executing them to create a project structure and write content. It features automatic context management to handle large amounts of text, real-time streaming of its thought process, and a recovery mechanism to resume interrupted work.

### Core Technologies

*   **Language:** Python 3
*   **AI Model:** Moonshot AI `kimi-k2-thinking`
*   **Key Libraries:**
    *   `openai`: To interact with the Moonshot API (which is OpenAI-compatible).
    *   `httpx`: For making HTTP requests, specifically to the token estimation endpoint.
    *   `python-dotenv`: For managing environment variables (API keys).

### Architecture

The project follows a modular structure:

*   `kimi-writer.py`: The main entry point and agent orchestrator. It contains the primary agent loop, handles model interaction, manages the conversation history (context), and decides when to call tools.
*   `tools/`: A package containing the actions the agent can perform.
    *   `project.py`: Manages the creation and tracking of a project folder where all output is stored.
    *   `writer.py`: Handles writing content to markdown files within the active project folder.
    *   `compression.py`: Provides functionality to summarize and compress the conversation history to stay within the model's token limit.
*   `utils.py`: A collection of helper functions that provide the system prompt, tool definitions for the model, a mapping from tool names to their Python implementations, and token counting logic.
*   `output/`: A directory (created automatically) that contains all the projects generated by the agent.

## Building and Running

### 1. Setup

**a. Configure Environment:**

Create a `.env` file in the project root by copying the example file:

```bash
cp env.example .env
```

Edit the `.env` file and add your Moonshot API key:

```
MOONSHOT_API_KEY=your-api-key-here
```

**b. Install Dependencies:**

It is recommended to use a virtual environment. Dependencies are listed in `requirements.txt`.

```bash
# Using pip
pip install -r requirements.txt

# Or using uv (as recommended in the README)
uv pip install -r requirements.txt
```

### 2. Running the Agent

There are three ways to run the agent:

**a. Fresh Start (Inline Prompt):**

Provide the writing task directly as a command-line argument.

```bash
python kimi-writer.py "Write a 3-chapter mystery novel set in a futuristic city."
```

**b. Fresh Start (Interactive):**

Run the script without arguments to be prompted for a task.

```bash
python kimi-writer.py
```

**c. Recovery Mode:**

Resume a previously interrupted session using a context summary file. These summaries are saved automatically in the project's folder within the `output/` directory.

```bash
python kimi-writer.py --recover output/your_project_name/.context_summary_YYYYMMDD_HHMMSS.md
```

## Development Conventions

*   **Tool-Based Architecture:** The agent's capabilities are defined by a set of tools. To add new functionality, create a new tool implementation in the `tools/` directory and register it in `utils.py` (`get_tool_definitions` and `get_tool_map`).
*   **System Prompt Driven:** The agent's behavior, persona, and high-level instructions are defined in the `get_system_prompt()` function in `utils.py`. Modifications to its core instructions should be made there.
*   **State Management:** The active project folder is managed via a global variable in `tools/project.py`. This is a simple form of state management that other tools rely on.
*   **Context Management:** The conversation history (`messages` list) is the agent's primary context. It is passed to the model on each iteration and is automatically compressed when it approaches the token limit.
*   **File IO:** All file output is directed to a sub-folder within the `output/` directory. The agent should not modify files outside of this directory.
*   **Testing:** (Inferred) There are no explicit tests in the repository. Adding a test suite using a framework like `pytest` would be a valuable addition. Tests could mock the API calls and verify that the agent correctly calls tools and manages files based on simulated model responses.
